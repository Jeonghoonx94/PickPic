<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.web.blog.model.mapper.PostMapper">

	<select id="getTotalCount" parameterType="map" resultType="int">
		select count(email)
		from post
		<if test="word != null and word != ''">
			<if test="key == 'title'">
				where subject like concat('%', #{word}, '%')
			</if>
			<if test="key != 'title'">
				where #{key} = #{word}
			</if>
		</if>
	</select>
	
	<select id="getCount" resultType="int">
		select count(*)
		from post
	</select>
	
	<select id="getOne" parameterType="int" resultType="PostDto">
		select p.*, m.name
		from post p join member m
				using(email)
		where postNo = #{postMo}
	</select>
	
	<select id="getList" parameterType="map" resultType="PostDto">
		select postNo, title, content,
				case when date_format(uploadDate, '%Y%m%d') = date_format(now(), '%Y%m%d')
				then date_format(uploadDate, '%H:%i:%s')
				else date_format(uploadDate, '%y.%m.%d')
				end uploadDate,
				case when date_format(modifyDate, '%Y%m%d') = date_format(now(), '%Y%m%d')
				then date_format(modifyDate, '%H:%i:%s')
				else date_format(modifyDate, '%y.%m.%d')
				end modifyDate,
				likeCnt, email, name
		from post join member using(email)
		where temp = 0
		<if test="word != null and word != ''">
			<if test="key == 'title'">
				and title like concat('%', #{word}, '%')
			</if>
			<if test="key != 'title'">
				and #{key} = #{word}
			</if>
		</if>
		order by postNo desc, modifyDate desc
		limit #{start}, #{spp}
	</select>
	
	<select id="getTempList" parameterType="map" resultType="PostDto">
		select postNo, title, content, temp, 
				case when date_format(uploadDate, '%Y%m%d') = date_format(now(), '%Y%m%d')
				then date_format(uploadDate, '%H:%i:%s')
				else date_format(uploadDate, '%y.%m.%d')
				end uploadDate,
				case when date_format(modifyDate, '%Y%m%d') = date_format(now(), '%Y%m%d')
				then date_format(modifyDate, '%H:%i:%s')
				else date_format(modifyDate, '%y.%m.%d')
				end modifyDate,
				likeCnt, email, name
		from post join member using(email)
		where temp = 1 and email = #{email}
		order by postNo desc, modifyDate desc
		limit #{start}, #{spp}
	</select>
	
	<insert id="write" parameterType="PostDto">
		insert into post (title, content, email)
		values (#{title}, #{content}, #{email})
	</insert>
	
	<insert id="writeTemp" parameterType="PostDto">
		insert into post (title, content, email, temp)
		values (#{title}, #{content}, #{email}, 1)
	</insert>
	
	<update id="writeTemptoDB" parameterType="PostDto">
		update post
		set temp = 0, title = #{title}, content = #{content}, uploadDate = current_timestamp, modifyDate = current_timestamp
		where postNo = #{postNo}
	</update>
	
	<update id="modify" parameterType="PostDto">
		update post
		set title = #{title}, content = #{content}, modifyDate = current_timestamp
		where postNo = #{postNo}
	</update>
	
	<delete id="delete" parameterType="int">
		delete from post
		where postNo = #{postNo}
	</delete>
	
<!-- 	게시글 like 수 -->
 	<select id="likeCount" parameterType="int" resultType="int">
 		select count(pmLikeNo)
 		from post_member_like
 		where postNo = #{postNo}
 			and likeCheck = 'Y'
 	</select>
	
<!-- 	한 사용자가 특정 게시물에 좋아요 했었는지  -->
	<select id="likeCheck" parameterType="map" resultType="int">
	    select count(pmLikeNo)
	    from post_member_like
	    where postNo=#{postNo}
			and email=#{email}
	</select>
	
<!-- 	한 사용자가 특정 게시물에 좋아요 했었던 정보 -->
	<select id="likeInfo" parameterType="map" resultType="PostLikeDto">
	    select pmLikeNo, postNo, email, likeCheck
	    from post_member_like
	    where postNo=#{postNo}
			and email=#{email}
	</select>
	
	<insert id="insertLike" parameterType="map">
		insert into post_member_like(postNo, email)
		values (#{postNo}, #{email})
	</insert>
	
<!-- 	<update id="like" parameterType="int"> -->
<!-- 		update post -->
<!-- 		set likeCnt = likeCnt + 1 -->
<!-- 		where postNo = #{postNo} -->
<!-- 	</update> -->
	<update id="like" parameterType="map">
		update post_member_like
		set likeCheck = 'Y'
		where postNo = #{postNo} and email = #{email}
	</update>
	
<!-- 	<update id="unlike" parameterType="int"> -->
<!-- 		update post -->
<!-- 		set likeCnt = likeCnt - 1 -->
<!-- 		where postNo = #{postNo} -->
<!-- 	</update> -->
	<update id="unlike" parameterType="map">
		update post_member_like
		set likeCheck = 'N'
		where postNo = #{postNo} and email = #{email}
	</update>
	
	<update id="updateLike" parameterType="map">
		update post_member_like
		set likeCheck = 
			case
				when likeCheck = 'Y' 
					then 'N'
				when likeCheck = 'N'
					then 'Y'
		where postNo = #{postNo} and email = #{email}
	</update>
	
	<update id="likeCntUp" parameterType="int">
		update post
		set likeCnt = likeCnt + 1
		where postNo = #{postNo}
	</update>
	
	<update id="likeCntDown" parameterType="int">
		update post
		set likeCnt = likeCnt - 1
		where postNo = #{postNo}
	</update>
	
	
	<select id="getLastPostNo" parameterType="string" resultType="int">
		select postNo
		from post
		where email = #{email}
		order by modifyDate desc
		limit 1
	</select>
	
	<insert id="uploadFile">
		insert into post_pics (postNo, oriPicName, modPicName, picSize)
		values(#{postNo}, #{oriPicName}, #{modPicName}, #{picSize})
	</insert>
	
	<select id="getFiles" parameterType="int" resultType="ImgDto">
		select picNo, postNo, oriPicName, modPicName,
			round(picSize/1024, 1) as picSize, 
			date_format(uploadDate, '%Y%m%d') as uploadDate
		from post_pics
		where postNo = #{postNo}
<!-- 			and deleted = 'N' -->
	</select>
	
	<select id="getFileInfo" parameterType="string" resultType="ImgDto">
		select picNo, postNo, oriPicName, modPicName,
			round(picSize/1024, 1) as picSize, 
			date_format(uploadDate, '%Y%m%d') as uploadDate
		from post_pics
		where picNo = #{picNo}
<!-- 			and deleted = 'N' -->
	</select>
	
<!-- 	<update id="deleteImgs" parameterType="int"> -->
<!-- 		update post_pics -->
<!-- 		set deleted = 'Y' -->
<!-- 		where postNo = #{postNo} -->
<!-- 	</update> -->
	<delete id="deleteImgs" parameterType="list">
<!-- 		delete from post_pics -->
<!-- 		where postNo in (  -->
<!-- 				select postNo -->
<!-- 				from ( -->
<!-- 						select postNo -->
<!-- 						from post_pics -->
<!-- 						where picNo in -->
<!-- 							<foreach collection="list" item="item" separator="," open="(" close=")"> -->
<!-- 								#{item} -->
<!-- 							</foreach> -->
<!-- 					) as temp -->
<!-- 			) -->
<!-- 		and picNo not in  -->
<!-- 			<foreach collection="list" item="item" separator="," open="(" close=")"> -->
<!-- 				#{item} -->
<!-- 			</foreach> -->
			delete from post_pics
			where picNo in 
			<foreach collection="list" item="item" separator="," open="(" close=")">
				#{item}
			</foreach>
	</delete>
	
<!-- 	<update id="deleteImg" parameterType="int"> -->
<!-- 		update post_pics -->
<!-- 		set deleted = 'Y' -->
<!-- 		where picNo = #{picNo} -->
<!-- 	</update> -->
	<delete id="deleteImg" parameterType="int">
		delete from post_pics
		where picNo = #{picNo}
	</delete>

	<select id="getCountFiles" parameterType="int" resultType="int">
		select count(picNo)
		from post_pics
		where postNo = #{postNo}
<!-- 			and deleted = 'N' -->
	</select>
	
</mapper>